Техническое задание (ТЗ)
Проект: Система управления заказами через Telegram-бот и API
1. Общие положения
1.1. Цель проекта
Разработать систему управления заказами, которая позволяет пользователям через Telegram-бот регистрироваться, создавать заказы, оставлять отзывы, управлять своим профилем, а также предоставляет администратору возможность управлять категориями, городами и пользователями через API и бот. Система включает серверную часть (API на FastAPI) и клиентскую часть (Telegram-бот).

1.2. Назначение системы
Для пользователей: удобный интерфейс через Telegram для работы с заказами, предложениями и отзывами.
Для администраторов: управление данными системы (города, категории, пользователи, заказы) через API и Telegram-бот.
Для исполнителей: возможность предлагать свои услуги через систему предложений.
1.3. Технологический стек
Backend: FastAPI (Python), SQLAlchemy (ORM), PostgreSQL (база данных).
Frontend: Telegram-бот (aiogram, Python).
Протоколы: HTTP (API), Telegram Bot API.
2. Функциональные требования
2.1. Сущности системы
User (Пользователь):
Поля: telegram_id, name, username, is_customer, is_executor, is_admin, city_id, rating, completed_orders.
Ограничения: пользователь не может быть одновременно заказчиком и исполнителем.
City (Город):
Поля: id, name.
Ограничения: уникальность имени.
Category (Категория):
Поля: id, name.
Ограничения: уникальность имени.
Order (Заказ):
Поля: id, customer_id, executor_id, category_id, title, description, desired_price, due_date, created_at, status.
Статусы: pending, in_progress, completed, canceled.
Offer (Предложение):
Поля: id, order_id, executor_id, price, estimated_time, status, created_at.
Статусы: pending, accepted, rejected.
Review (Отзыв):
Поля: id, order_id, author_id, target_id, rating, comment, created_at.
Ограничения: рейтинг от 1 до 5.
2.2. CRUD-операции (API)
Каждая сущность поддерживает полный набор CRUD-операций через REST API:

User:
POST /user/ — создание пользователя.
GET /user/me — получение текущего пользователя.
GET /user/by_telegram_id/{telegram_id} — получение пользователя по Telegram ID.
GET /user/all — список всех пользователей (админ).
PATCH /user/me — обновление текущего пользователя.
PATCH /user/{id} — обновление пользователя по ID (админ).
DELETE /user/{id} — удаление пользователя (админ).
City:
POST /city/ — создание города (админ).
GET /city/ — список всех городов.
GET /city/{id} — получение города по ID.
PATCH /city/{id} — обновление города (админ).
DELETE /city/{id} — удаление города (админ).
Category:
POST /category/ — создание категории (админ).
GET /category/ — список всех категорий.
GET /category/{id} — получение категории по ID.
PATCH /category/{id} — обновление категории (админ).
DELETE /category/{id} — удаление категории (админ).
Order:
POST /order/ — создание заказа (заказчик).
GET /order/ — список заказов пользователя.
GET /order/{id} — получение заказа по ID.
PATCH /order/{id} — обновление заказа (заказчик).
DELETE /order/{id} — удаление заказа (админ).
POST /order/{id}/cancel — отмена заказа (заказчик, в течение 5 минут).
Offer:
POST /offer/ — создание предложения (исполнитель).
GET /offer/ — список предложений пользователя.
GET /offer/{id} — получение предложения по ID.
PATCH /offer/{id} — обновление предложения (исполнитель).
DELETE /offer/{id} — удаление предложения (исполнитель).
Review:
POST /review/ — создание отзыва (заказчик).
GET /review/ — список отзывов пользователя.
GET /review/{id} — получение отзыва по ID.
PATCH /review/{id} — обновление отзыва (автор).
DELETE /review/{id} — удаление отзыва (админ).
2.3. Telegram-бот
Команды:
/start — регистрация/авторизация пользователя, отображение главного меню.
Профиль — просмотр и редактирование профиля (имя, город, роль).
Создать заказ — создание нового заказа с пошаговым вводом данных.
Список заказов — просмотр списка заказов с возможностью отмены.
Сменить роль — переключение между заказчиком и исполнителем.
Города — просмотр списка городов.
Категории — просмотр списка категорий.
Админ-панель (для админа) — управление системой.
Функциональность:
Регистрация: При первом запуске создается пользователь с ролью заказчика и городом по умолчанию.
Профиль: Отображение данных, редактирование имени и города.
Заказы: Создание, просмотр, отмена (в течение 5 минут).
Админ-функции: Удаление городов, категорий, заказов.
2.4. Авторизация
API: Используется заголовок x-telegram-id для идентификации пользователя.
Админ: Проверка Telegram ID на соответствие ADMIN_TELEGRAM_ID.
3. Нефункциональные требования
3.1. Производительность
API должен обрабатывать до 100 запросов в секунду.
Время ответа Telegram-бота не более 2 секунд.
3.2. Безопасность
Проверка ролей для операций (заказчик, исполнитель, админ).
Защита от SQL-инъекций через SQLAlchemy ORM.
Уникальность telegram_id и username.
3.3. Надежность
Обработка ошибок API с возвращением понятных сообщений (например, 404 Not Found, 403 Forbidden).
Транзакционная целостность для операций с базой данных.
3.4. Масштабируемость
Возможность добавления новых сущностей и операций через модульную структуру.
4. Архитектура системы
4.1. Структура проекта
FastAPI (API):
app/main.py — точка входа.
app/core/models/ — модели базы данных (SQLAlchemy).
app/core/schemas/ — схемы Pydantic для валидации данных.
app/core/services/ — бизнес-логика.
app/api/ — маршруты API.
app/core/database/ — настройка подключения к БД.
app/api/depends/ — зависимости (авторизация).
Telegram-бот:
app/bot/bot_runner.py — запуск бота.
app/bot/handlers/ — обработчики команд и callback’ов.
app/bot/config.py — конфигурация (токен, URL API).
4.2. База данных
Используется PostgreSQL.
Таблицы:
users, cities, categories, user_categories (связь многие-ко-многим), orders, offers, reviews.
4.3. Взаимодействие
Telegram-бот отправляет HTTP-запросы к FastAPI через aiohttp.
FastAPI взаимодействует с PostgreSQL через SQLAlchemy.
5. Интерфейсы
5.1. API
Формат: JSON.
Пример запроса (создание заказа):
json

POST /order/
{
  "category_id": 1,
  "title": "Ремонт телефона",
  "description": "Замена экрана",
  "desired_price": 5000.0,
  "due_date": "2025-03-20T12:00:00"
}
Headers: {"x-telegram-id": "123456789"}
Пример ответа:
json


{
  "id": 1,
  "customer_id": 1,
  "executor_id": null,
  "category_id": 1,
  "title": "Ремонт телефона",
  "description": "Замена экрана",
  "desired_price": 5000.0,
  "due_date": "2025-03-20T12:00:00",
  "created_at": "2025-03-10T10:00:00",
  "status": "pending"
}
5.2. Telegram-бот
Главное меню:

[Профиль] [Создать заказ]
[Список заказов] [Сменить роль]
[Города] [Категории]
[Админ-панель] (для админа)
Пример взаимодействия:
Пользователь: "Создать заказ".
Бот: "Выберите категорию: [Категория 1] [Категория 2]".
Пользователь выбирает категорию, вводит данные, подтверждает.
6. Требования к развертыванию
6.1. Зависимости
Python 3.10+.
Библиотеки: fastapi, sqlalchemy, psycopg2-binary, pydantic, aiogram, aiohttp, python-dotenv.
6.2. Конфигурация
Файл .env:

DB_URL=postgresql://user:password@localhost:5432/dbname
BOT_TOKEN=your_telegram_bot_token
API_URL=http://127.0.0.1:8009/api/
ADMIN_TELEGRAM_ID=704342630
6.3. Запуск
API: uvicorn app.main:app --host 0.0.0.0 --port 8009 --reload.
Бот: python app/bot/bot_runner.py.
7. Этапы разработки
Проектирование: Анализ требований, создание моделей и схем (выполнено).
Реализация API: Полное покрытие CRUD для всех сущностей (выполнено).
Реализация Telegram-бота: Интеграция с API, обработка команд (частично выполнено).
Тестирование: Проверка всех операций через API и бот.
Деплой: Развертывание на сервере.
8. Критерии приемки
Все CRUD-операции работают через API (проверяется через Postman или curl).
Telegram-бот корректно выполняет команды /start, Профиль, Создать заказ, Список заказов, Сменить роль, Города, Категории, Админ-панель.
Ошибки обрабатываются с выводом понятных сообщений.
Данные в базе данных сохраняются корректно.
